<script>
	function get_prediction_target_groups() {
		var tumor_type = $('select[name="tumor_type"]').val();
		var input_target = $('select[name="prediction_target"]').val();

		$.get('/analysis/get_unique_prediction_target_values', {tumor_type: tumor_type, prediction_target: input_target}, function (targets) {
			var html = '<select name="prediction_target_groups" style="width:100%" size="5" multiple>';
			targets.forEach(function(target) {
				html += '<option>' + target + '</option>'
			});
			html += '</select><br style="clear:both;">';
			html += '<div style="width:40%;float:left">';
				html += '<input type="button" value="Add to Group 1" onClick="addToPredictionTargetGroup(1)">';
				html += 'Group 1<br>';
				html += '<select style="width:100%" name="prediction_target_group1[]" id="pt_group1" size="5" multiple>';
				html += '</select>';
			html += '</div>';
			html += '<div style="width:20%;float:left;padding-top:50px;">';
				html += '<div style="margin-left:5px;">';
					html += '<input type="button" value=">" onClick="movePredictionTarget(1, 2)">';
					html += '<input type="button" value="<" onClick="movePredictionTarget(2, 1)">';
				html += '</div>';
			html += '</div>';
			html += '<div style="width:40%;float:left">';
				html += '<input type="button" value="Add to Group 2" onClick="addToPredictionTargetGroup(2)">';
				html += 'Group 2<br>';
				html += '<select style="width:100%" name="prediction_target_group2[]" id="pt_group2" size="5" multiple>';
				html += '</select>';
			html += '</div>';
			html += '<br style="clear:both;"><input type="button" value="Reset" onClick="reset_prediction_target_groups()">';
			$("#prediction_target_groups").html(html);
		});
	}

	function reset_prediction_target_groups() {
		get_prediction_target_groups();
	}

	function get_prediction_targets() {
		$('select[name="prediction_target"]').html("");

		var tumor_type = $('select[name="tumor_type"]').val();
		if (tumor_type) {
			$.get('/analysis/get_prediction_targets', {tumor_type: tumor_type}, function (data) {
				var html = ""
				data.forEach(function(prediction_target) {
					html += '<option>' + prediction_target + '</option>'
				});
				$('select[name="prediction_target"]').html(html);

				get_prediction_target_groups();
				$(document).on('change', 'select[name="prediction_target"]', function() {
					get_prediction_target_groups();
				});
			});
		}
	}

	function addToPredictionTargetGroup(n) {
		var group = $('select[name="prediction_target_group' + n + '[]"]');
		
		var selected_values = $('select[name="prediction_target_groups"]').val();
		if (!selected_values) {
			return;
		}

		var html = '';
		selected_values.forEach(function(selected_value) {
			html += '<option>' + selected_value + '</option>';
		});
		group.append(html);

		html = "";
		$('select[name="prediction_target_groups"] option').each(function() {
			if (selected_values.indexOf($(this).text()) == -1) {
				html += '<option>' + $(this).text() + '</option>';
			}
		});
		$('select[name="prediction_target_groups"]').html(html);
	}

	function movePredictionTarget(source, destination) {
		var selected_values = $('select[name="prediction_target_group' + source + '[]"]').val();
		if (!selected_values) {
			return;
		}

		var destination_group = $('select[name="prediction_target_group' + destination + '[]"]');

		var html = '';
		selected_values.forEach(function(selected_value) {
			html += '<option>' + selected_value + '</option>';
		});
		destination_group.append(html);

		html = "";
		$('select[name="prediction_target_group' + source + '[]"] option').each(function() {
			if (selected_values.indexOf($(this).text()) == -1) {
				html += '<option>' + $(this).text() + '</option>';
			}
		});
		$('select[name="prediction_target_group' + source + '[]"]').html(html);
	}

	function submitForm() {
  		var option_tags = $('select[name="prediction_target_group1[]"] option');
		var options = [];
		option_tags.each(function() {
			options.push($(this).val());
		});

		$('select[name="prediction_target_group1[]"]').val(options);

		option_tags = $('select[name="prediction_target_group2[]"] option');
		options = [];
		option_tags.each(function() {
			options.push($(this).val());
		});

		$('select[name="prediction_target_group2[]"]').val(options);
	}


	$(document).ready(function() {
		get_prediction_targets();
		$(document).on('change', 'select[name="tumor_type"]', function(){
			get_prediction_targets();
		});
	});


	$(document).on('change', 'input[name="data_source"]:radio', function(){
	  render_list()
	});

	$(document).on('change', 'input[name="feature_selection_method"]:radio', function(){
	  render_list();
	});

	function render_list() {
		var source = $("input[name='data_source']:checked").val();
		var method = $("input[name='feature_selection_method']:checked").val();
		
		if (source == "proteomics") {
			$("#go_link").hide();
		}
		else {
			$("#go_link").show();
		}

		$.get('/analysis/get_features', {source: source, method: method}, function (data) {
			var features = '';
			content = '<table style="width:100%;">';
			for (var d in data) {
				s = data[d].trim().split("\t");
				content += '<tr><td><a href="http://www.genecards.org/cgi-bin/carddisp.pl?gene='+s[0]+'" target="_blank">'+s[0]+"</a></td><td>"+s[1]+'</td></tr>';
				features += s[0]+"\n";
			}
			content += '</table>';
			$("#features").html(content);
			$("#target_set").val(features);
		});
	}
	
	function go_analysis() {
		document.getElementById("go_form").submit();	
	}
</script>

<h2>Classification of Clinical Phenotypes</h2>
<% if @valid_command %>
	<b>(For testing) Command: <%= @command %></b>
<% end %>
<form id="generate_binary_analysis_form" method="post" action="/analysis/stage#progressbar">
	<div style="float:left;width:300px;">
		<h4>Choose the Tumor Type</h4>
		<div class="well">
			<%= select_tag "tumor_type", options_for_select({'Choose Tumor Type' => ''}.merge(SiteConstants::TUMOR_TYPES.invert)) %>
		</div>
	</div>
	<div style="float:left;width:300px;margin-left:10px;">
		<h4>Choose the Data Source</h4>
		<div class="well">
			<%= select_tag "data_source", options_for_select({'Choose Data Source' => ''}.merge(SiteConstants::DATA_TYPES.invert)) %>
		</div>
	</div>
	<div style="float:left;width:375px;margin-left:10px;">
		<h4>Choose the Prediction Target</h4>
		<div class="well">
			<%= select_tag "prediction_target" %>
			<div id="prediction_target_groups"></div>
		</div>
	</div>

	<br style="clear:both;">
	<div style="float:left;width:490px;">
		<%= render partial: 'batch' %>
	</div>
	<div style="float:left;width:490px; margin-left: 10px">
		<h4>Choose the Feature Selection Method</h4>
		<div class="well">
			<%= select_tag "feature_selection_method", options_for_select(SiteConstants::FEATURE_SELECTION_METHOD.invert) %>
			<div id="features" style="overflow:auto;height:200px;width:300px;margin-top:5px;border:2px solid #000;"></div>
			<br><div id="go_link"><input type="button" class="btn" onClick="go_analysis()" value="Run GO analysis on feature set"></div>
		</div>

		<div class="well">
			Use top <input type="text" name="num_top_features" value="10" style="width:30px;"> features for building the machine learning models.
			Click the links to visit the relevant GeneCard page.
		</div>
	</div>
	<br style="clear:both;">
	<div style="text-align: center">
		<input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>"></input>
		<input type="hidden" name="session_id" value="<%= rand.to_s.sub("0.", "") %>">
		<div id="form_error_message_field" style="color:red; margin-bottom:5px;"></div>
		<input type="submit" onClick="submitForm(); return true" value="Generate Analysis" name="generate" class="btn btn-primary" style="height:50px;font-size:16pt;" id="generate-analysis-button">
	</div>
	<div id="progressbar" style="width:90%; margin-left:auto; margin-right:auto; margin-top:10px;"></div>
	<div id="progressbar-status" style="width:90%; margin-left:auto; margin-right:auto;"></div>
</form>

<br style="clear:both;">

<% if params[:done] %>
	<h2 id="results">Results</h2>
	<div class="well" style="width:600px">
		<a href="/sessions/<%= @sessionID%>/roc.png" target="_blank">
			<img src="/sessions/<%= @sessionID%>/roc.png">
		</a>
	</div>
	<b>Area Under Curve for machine learning models:</b>
	<div class="well">
		<table>
			<tr>
				<th>Model</th>
				<th>AUC</th>
			</tr>
		<% @area_under_curve.each do |auc| %>
			<tr>
				<td><%= auc[1] %></td>
				<td><%= auc[0].to_f.round(4) %></td>
			</tr>
		<% end %>
		</table>
	</div>
	<b>Decision Tree</b>
	<div class="well" style="width:600px">
		<a href="/sessions/<%= @sessionID%>/decisionTree.png" target="_blank">
			<img src="/sessions/<%= @sessionID%>/decisionTree.png">
		</a>
	</div>

	<table>
		<tr>
			<th colspan="2">Feature</th>
			<th>Weight</th>
		</tr>
	<% @feature_weights.each do |feature_weight| %>
		<tr>
			<td><input type="checkbox" name="feature_weights" value="<%= feature_weight[:value] %>"></td>
			<td><a href="http://www.genecards.org/Search/Keyword?queryString=<%= feature_weight[:value] %>" target="_blank"><%= feature_weight[:name] %></a></td>
			<td><%= feature_weight[:weight].to_f.round(5) %></td>
		</tr>
	<% end %>
	</table>
	<input type="button" class="btn" onClick="resultsManager.run_stringdb()" value="Search String DB">

	<div style="visibility:hidden">
		<form method="post" action="http://string-db.org/newstring_cgi/show_network_section.pl" target="_blank" enctype="multipart/form-data" id="stringdb_form">
			<input type="hidden" name="flash" value="19">
			<input type="hidden" name="required_score" value="400">
			<input type="hidden" name="empty" value="">
			<input type="hidden" name="have_user_input" value="2">
			<input type="hidden" name="multi_input" value="1">
			<input type="hidden" name="multiple_input_type" value="multi_identifier">
			<input type="hidden" name="advanced_menu" value="yes">
			<input type="hidden" name="limit" value="0">
			<input type="hidden" name="species_text" value="Homo sapiens">
			<input type="hidden" name="input_query_species" value="auto_detect">
			<textarea id="stringdb_input" name="multiple_input_items" rows="10" cols="40"></textarea>
			<input type="submit">
		</form>
	</div>
<% else %>
	<br><br><br>
<% end %>

<br style="clear:both;">
<div style="display:none;">
	<form id="go_form" method="post" target="_blank" action="http://cbl-gorilla.cs.technion.ac.il/servlet/GOrilla">
		<input type="hidden" name="application" value="gorilla">
		<input type="hidden" name="species" value="HOMO_SAPIENS">
		<input type="hidden" name="run_mode" value="mhg">
		<input type="hidden" name="target_file_name" value="">
		<input type="hidden" name="background_set" value="">
		<input type="hidden" name="background_file_name" value="">
		<input type="hidden" name="db" value="all">
		<input type="hidden" name="run_gogo_button" value="Search Enriched GO terms">
		<input type="hidden" name="pvalue_thresh" value="0.001">
		<input type="hidden" name="analysis_name" value="">
		<input type="hidden" name="user_email" value="">
		<input type="hidden" name="fast_mode" value="on">
		<textarea id="target_set" name="target_set"></textarea>
	</form>
</div>

<script>
	render_list();
	var resultsManager = new ResultsManager("<%= params[:session_id] %>");
	<% if params[:generate] %>
		resultsManager.run('stage');
	<% end %>

	$('#generate_binary_analysis_form').submit(function(e) {
		if (!$('#tumor_type').val() || !$('#data_source').val() || !$('select[name="prediction_target_group1[]"] option').text() || !$('select[name="prediction_target_group2[]"] option').text()) {
			$('#form_error_message_field').html("Must select both a tumor type, a data source, a group1 prediction target, and a group2 prediction target.");
			return false;
		}
	});
</script>
